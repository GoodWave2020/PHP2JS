/** QuickRequest v1.0 | Script | (c) Raul Mauricio Uñate Castro | https://github.com/rmunate | MIT */
function __extractLastSegment(e,t="/"){if(!__isValueEmpty(e)){let i=e.split(t),n=i[i.length-1];return n}return""}function __isValueEmpty(e){return!!(null==e||"string"==typeof e&&""===e.trim()||Array.isArray(e)&&0===e.length)||"object"==typeof e&&0===Object.keys(e).length}class QuickRequestException{constructor(e){let t=Error(e);throw console.error("⚠ QuickRequestException ⚠ | "+t.toString(),{name:t.name,message:t.message,trace:t.stack.split("\n").map(function(e){return e.trim().replaceAll("at ","\uD83D\uDD0D At: ")})})}}class QuickRequestValidate{constructor(e){let t=["url"];t.forEach(t=>{if(!e.hasOwnProperty(t))throw new QuickRequestException("The property '"+t+"' is mandatory in the request options.")})}}class QuickRequestElements{tagCheck(e){return["INPUT","TEXTAREA","SELECT"].includes(e.tagName)}typeCheck(e){return!["submit","button"].includes(e.type)}typeFile(e){return"file"===e.type}typeCheckboxOrRadio(e){return["radio","checkbox"].includes(e.type)}}class QuickRequestMain{constructor(){this.config={expect:"JSON",confirm:!1,activateEvent:!1,eventListener:{},preventDefault:!0,method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="__QuickRequestToken"]').getAttribute("content"),Accept:"application/json"}}}eventListener(e,t){if(__isValueEmpty(e))throw new QuickRequestException("You must define a valid event within the eventListener method(<<Method>>,<<Selectors>>)");if(__isValueEmpty(t))throw new QuickRequestException("You must define a valid selector within the eventListener method(<<Method>>,<<Selectors>>)");return this.config.activateEvent=!0,this.config.eventListener.event=e,this.config.eventListener.selectors=document.querySelectorAll(t),this}preventDefault(e=!0){if(!0!==e&&!1!==e)throw new QuickRequestException("The argument can only be <<true>> or <<false>>, or omit it to default to <<true>>");return this.config.preventDefault=e,this}headers(e={}){return this.config.headers={...this.config.headers,...e},this}confirm(e){return this.config.confirm=e,this}post(e={}){this.config.method="POST",e.hasOwnProperty("headers")&&(this.headers(e.headers),delete e.headers),this.config.options=e,this.config.expect=e.expect||"JSON";let t=new QuickRequestEvents(this.config);return t.handler}get(e={}){this.config.method="GET",e.hasOwnProperty("headers")&&(this.headers(e.headers),delete e.headers),this.config.options=e,this.config.expect=e.expect||"JSON";let t=new QuickRequestEvents(this.config);return t.handler}put(e={}){this.config.method="PUT",e.hasOwnProperty("headers")&&(this.headers(e.headers),delete e.headers),this.config.options=e,this.config.expect=e.expect||"JSON";let t=new QuickRequestEvents(this.config);return t.handler}patch(e={}){this.config.method="PATCH",e.hasOwnProperty("headers")&&(this.headers(e.headers),delete e.headers),this.config.options=e,this.config.expect=e.expect||"JSON";let t=new QuickRequestEvents(this.config);return t.handler}delete(e={}){this.config.method="DELETE",e.hasOwnProperty("headers")&&(this.headers(e.headers),delete e.headers),this.config.options=e,this.config.expect=e.expect||"JSON";let t=new QuickRequestEvents(this.config);return t.handler}}class QuickRequestEvents{constructor(e){this.config=e,this.config.callbacksEvents=[],new QuickRequestValidate(this.config.options),this.checkEvent()}checkEvent(){if(this.config.activateEvent){let e=this;this.config.eventListener.selectors.forEach(function(t){let i=function(t){e.config.preventDefault&&t.preventDefault(),new QuickRequestFetch(e.config)};t.addEventListener(e.config.eventListener.event,i),e.config.callbacksEvents.push({element:t,event:e.config.eventListener.event,func:i})}),e.handler=new QuickRequesHandler(e.config)}else new QuickRequestFetch(this.config),this.handler=new QuickRequesHandler(this.config)}}class QuickRequestFetch{constructor(e){this.config=e,this.config.baseUrl=`${window.location.protocol}//${window.location.host}/`,this.config.formData=new FormData,this.config.hasFile=!1,this.dispatch()}data(){let e=this.config.options.form||null;if(null!==e){let t=new QuickRequestElements,i=Array.from(document.getElementById(e).elements);i.forEach(e=>{t.tagCheck(e)&&t.typeCheck(e)&&(t.typeFile(e)?e.files.length>0&&(this.config.formData.append(e.name,e.files[0]),this.config.hasFile=!0):t.typeCheckboxOrRadio(e)?e.checked&&this.config.formData.append(e.name,e.value):__isValueEmpty(e.value)||this.config.formData.append(e.name,e.value))});let n=this.config.options.data||null;if(!__isValueEmpty(n))for(let[s,o]of Object.entries(n))this.config.formData.append(s,o)}else{let r=this.config.options.data||null;if(!__isValueEmpty(r))for(let[c,a]of Object.entries(r))this.config.formData.append(c,a)}}method(){let e=(this.config.baseUrl+this.config.options.url).replaceAll("//","/").replaceAll(":/","://"),t={};if(["GET","HEAD"].includes(this.config.method)){if(this.config.hasFile)throw new QuickRequestException("File uploads are not allowed with "+this.config.method+" due to URL length limitations; use POST instead.");if(e.includes("?"))throw new QuickRequestException("The URL appears to already have a query, as it contains the '?' character in its structure. In case you need to send additional data, use the 'data' property.");e=`${e}?${new URLSearchParams(this.config.formData).toString()}`,t={method:this.config.method,headers:this.config.headers}}else if(["PATCH","PUT","DELETE"].includes(this.config.method)){if(this.config.hasFile)throw new QuickRequestException("File uploads are not allowed with "+this.config.method+" as it uses JSON headers; use POST instead.");let i={};for(let[n,s]of this.config.formData.entries()){let o=n.includes("[]"),r=n.replace("[]","");if(void 0===i[r])o?i[r]=[s]:i[r]=s;else try{i[r].push(s)}catch(c){throw new QuickRequestException("Two distinct inputs, excluding Checkboxes and Radios, have the same name '"+r+"' without the square brackets '[]', which prevents them from being treated as the same data when sent to the backend as an array.")}}this.config.headers["Content-Type"]="application/json",t={method:this.config.method,headers:this.config.headers,body:JSON.stringify(i)}}else t={method:this.config.method,headers:this.config.headers,body:this.config.formData};return{realUrl:e,realParams:t}}dispatch(){"function"==typeof this.config.confirm?!0===this.config.confirm()&&this.send():this.send()}async send(){this.data(),this.config.options.before&&"function"==typeof this.config.options.before&&this.config.options.before();let e={},t,i=this.method(),n=await fetch(i.realUrl,i.realParams);if(n.ok){try{if("json"==this.config.expect.toLowerCase().trim())t=await n.json();else if("text"==this.config.expect.toLowerCase().trim())t=await n.text();else if("blob"==this.config.expect.toLowerCase().trim())t=await n.blob();else throw Error("Only the values 'json', 'blob' or 'text' are allowed for the 'expect' property.")}catch(s){throw new QuickRequestException(s.message)}e={data:t,success:n.ok,code:n.status},this.config.options.success(e)}else{try{t=await n.json()}catch(o){t=n.statusText}let r={},c;if(t.hasOwnProperty("exception")&&t.hasOwnProperty("file")&&t.hasOwnProperty("message"))c=`File: ${__extractLastSegment(t.file)} - Line: ${t?.line} - Exception: ${t.message}`,t.trace.forEach(e=>{let t=__extractLastSegment(e.file);__isValueEmpty(t)||(r[__extractLastSegment(e.file)]=[`Line: ${e?.line}, File: ${e?.file}, Function: ${e?.function}`])}),t={errors:r,message:c};else if(!t.hasOwnProperty("errors")){if("object"==typeof t&&Object.keys(t).length>0){let a=0;for(let[h,l]of Object.entries(t))r[h]=Array.isArray(l)?l:[l],0==a&&(c=h),a++;let u=a-1;u>=1&&(c+=". (and "+(a-1)+" more error)")}else r[t]=[t],c=Array.isArray(t)?t[0]:t;t={errors:r,message:c}}r={data:t,success:n.ok,code:n.status},this.config.options.error&&"function"==typeof this.config.options.error&&this.config.options.error(r)}this.config.options.after&&"function"==typeof this.config.options.after&&this.config.options.after({success:n.ok,data:t,code:n.status})}}class QuickRequesHandler{constructor({callbacksEvents:e,headers:t,method:i,options:n,preventDefault:s}){this.getMethod=function(){return i},this.getEndPoint=function(){return n.url},this.getIdForm=function(){return n.form||null},this.getData=function(){return n.data||null},this.getCustomHeaders=function(){return t},this.getEvents=function(){return{preventDefault:__isValueEmpty(e)?null:s,events:e}},this.call=function(){return{before:n.before,success:n.success,error:n.error,after:n.after}},this.getParams=function(){return n},this.removeEventListener=function(){return!__isValueEmpty(e)&&(e.forEach(e=>{e.element.removeEventListener(e.event,e.func)}),this.getEvents=function(){return[]},!0)}}}const QuickRequestBlobs={config:{blob:null,name:null,extension:null},setBlob:function(e){return this.config.blob=e,this},setName:function(e){return this.config.name=e,this},setExtension:function(e){return this.config.extension=e,this},download:function(){let{blob:e,name:t,extension:i}=this.config;if(!e)throw new QuickRequestException("Blob is not set in QuickRequestBlobs.setBlob().");if(!t)throw new QuickRequestException("Name is not set in QuickRequestBlobs.setName().");if(null===i&&e.type){let n=e.type.split("/");n.length>=1&&(i=n[1])}if(null===i)throw new QuickRequestException("Extension is not set in QuickRequestBlobs.setExtension().");let s=URL.createObjectURL(e),o=(t+"."+i).replaceAll("..","."),r=document.createElement("a");r.href=s,r.download=o,r.textContent=t;let c=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});r.dispatchEvent(c)}},QuickRequestErrors={config:{errors:{}},setErrors:function(e){return this.config.errors=e,this},toArray:function(){let e=[];for(let[t,i]of Object.entries(this.config.errors))e.push({[t]:i});return e},toArrayflatten:function(){let e=[];for(let[t,i]of Object.entries(err.data.errors))Array.isArray(i)?i.forEach(i=>{e.push({[t]:i})}):e.push({[t]:i});return e}},QuickRequest=new QuickRequestMain;